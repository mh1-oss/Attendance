<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>لوحة الأستاذ</title>
<style>
  :root{
    --bg:#f7f9fc; --card:#ffffff; --text:#0f172a; --muted:#64748b; --accent:#2563eb;
    --border:#e5e7eb; --ok:#16a34a; --bad:#dc2626; --chip:#eef2ff;
    --shadow:0 2px 10px rgba(15,23,42,.06);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text)}
  .wrap{max-width:1100px;margin:0 auto;padding:22px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px 0;box-shadow:var(--shadow);animation:pop .25s ease}
  h1{margin:0 0 10px;font-size:22px} h2{margin:0 0 10px;font-size:18px}
  label{display:block;margin:8px 0 6px;font-size:14px;color:var(--muted)}
  input,select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--text);transition:border .15s}
  input:focus,select:focus{outline:none;border-color:#93c5fd;box-shadow:0 0 0 3px #dbeafe}
  .row{display:flex;gap:12px;flex-wrap:wrap}.col{flex:1 1 240px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:var(--chip);color:#111827;cursor:pointer;transition:transform .06s ease, box-shadow .2s ease}
  button:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(0,0,0,.06)}
  button:active{transform:translateY(0)}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  button.danger{background:#fef2f2;border-color:#fecaca;color:#b91c1c}
  .muted{color:var(--muted);font-size:13px}
  .pill{display:inline-block;background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px}
  video{width:100%;max-height:360px;border-radius:12px;background:#000}
  table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:right}
  th{background:#fafafa;color:#111827}
  #stuQRWrap{display:none;align-items:center;gap:16px;flex-wrap:wrap}
  img.qr{background:#fff;border:1px solid var(--border);border-radius:12px;padding:8px;cursor:pointer;transition:transform .15s ease, box-shadow .2s}
  img.qr:hover{transform:scale(1.02);box-shadow:0 12px 28px rgba(0,0,0,.08)}
  #toast{position:fixed;top:16px;left:50%;transform:translateX(-50%) translateY(-20px);opacity:0;background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0;
         padding:12px 16px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.1);display:block;font-weight:600;pointer-events:none;transition:opacity .25s, transform .25s}
  #toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;animation:fade .2s ease}
  .modal img{max-width:95vw;max-height:90vh;background:#fff;border-radius:16px;padding:12px;border:1px solid var(--border);animation:pop .2s ease}
  td[contenteditable="true"]{outline:2px solid transparent;transition:background .15s}
  td[contenteditable="true"]:focus{outline:2px solid #bfdbfe;background:#eff6ff}
  tr.flash{animation:flash .6s ease}
  .filters{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  @keyframes flash{0%{background:#ecfeff}100%{background:transparent}}
  @keyframes fade{from{opacity:0}to{opacity:1}}
  @keyframes pop{from{transform:scale(.98);opacity:.0}to{transform:scale(1);opacity:1}}
</style>
</head>
<body>
<div class="wrap">
  <h1> لوحة الأستاذ </h1>

  <div class="card">
    <h2>إعداد الجلسة</h2>
    <div class="row">
      <div class="col">
        <label>كود الجلسة (يتولد تلقائيًا)</label>
        <input id="sess" placeholder="مثال: A5K9Q">
      </div>
      <div class="col">
        <label>عنوان المحاضرة</label>
        <input id="ltitle" placeholder="مثال: English">
      </div>
      <div class="col">
        <label>تاريخ المحاضرة</label>
        <input id="ldate" type="date">
      </div>
      <div class="col">
        <label>سياسة التكرارات</label>
        <div class="switch">
          <input type="checkbox" id="noDup" style="width:auto">
          <span class="muted">منع التكرارات (الجهاز الواحد = حضور واحد)</span>
        </div>
      </div>
    </div>
    <div class="controls">
      <button id="showStuQR" class="primary">إظهار QR لصفحة الطالب</button>
      <button id="startScan">تشغيل الماسح</button>
      <button id="stopScan">إيقاف</button>
      <button id="csvBtn">تصدير CSV</button>
      <button id="endBtn" class="danger">إنهاء الجلسة</button>
    </div>
    <div class="muted">أكمل **الكود + العنوان + التاريخ** قبل إظهار QR أو تشغيل الماسح.</div>

    <div id="stuQRWrap" style="margin-top:10px">
      <div>
        <div class="muted">إضغط على صورة الـ QR لتكبيرها.</div>
        <img id="stuQR" class="qr" width="240" height="240" alt="QR لفتح صفحة الطالب">
        <div class="pill" id="stuLink"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>كاميرا المسح</h2>
    <div class="row">
      <div class="col">
        <label>اختيار الكاميرا</label>
        <select id="cameraSelect"></select>
      </div>
      <div class="col">
        <label>حالة الماسح</label>
        <div id="status" class="muted">جاهز…</div>
      </div>
    </div>
    <video id="video" playsinline></video>
    <canvas id="canvas" style="display:none"></canvas>
  </div>

  <div class="card">
    <h2>قائمة الحضور <span id="count" class="pill">0</span></h2>

    <div class="filters">
      <input id="fName" placeholder="فلتر الاسم">
      <input id="fSec" placeholder="فلتر الشعبة">
      <button id="clearFilters">تنظيف الفلاتر</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>No.</th><th>Full Name</th><th>Section</th><th>Date</th><th>Lecture Title</th><th>Lecture Date</th><th>Session</th><th>ID</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <div class="muted">الاسم قابل للتعديل (انقر على الخلية). استخدم الفلاتر للبحث السريع.</div>
  </div>
</div>

<div id="toast">✅ تمت إضافة: <span id="toastName"></span></div>
<div id="qrModal" class="modal"><img id="qrBig" alt="QR كبير"></div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
(function(){
  // عناصر
  const sess   = document.getElementById('sess');
  const ltitle = document.getElementById('ltitle');
  const ldate  = document.getElementById('ldate');
  const noDup  = document.getElementById('noDup');

  const showStuQR = document.getElementById('showStuQR');
  const stuQRWrap = document.getElementById('stuQRWrap');
  const stuQR  = document.getElementById('stuQR');
  const stuLink= document.getElementById('stuLink');
  const qrModal= document.getElementById('qrModal');
  const qrBig  = document.getElementById('qrBig');

  const status = document.getElementById('status');
  const video  = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx    = canvas.getContext('2d');
  const camSel = document.getElementById('cameraSelect');
  const startBtn = document.getElementById('startScan');
  const stopBtn  = document.getElementById('stopScan');
  const csvBtn   = document.getElementById('csvBtn');
  const endBtn   = document.getElementById('endBtn');
  const tbody    = document.getElementById('tbody');
  const countEl  = document.getElementById('count');
  const toast    = document.getElementById('toast');
  const toastName= document.getElementById('toastName');

  const fName = document.getElementById('fName');
  const fSec  = document.getElementById('fSec');
  const clearFilters = document.getElementById('clearFilters');

  // أدوات
  function todayISO(){ return new Date().toISOString().slice(0,10); } // تاريخ فقط
  function randCode(n=5){const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';let s='';for(let i=0;i<n;i++) s+=c[Math.floor(Math.random()*c.length)];return s;}
  function ok(v){ return (v||'').trim().length>0; }
  function requireFields(){
    if(!ok(sess.value))  { alert('أدخل/تأكّد من كود الجلسة'); return false; }
    if(!ok(ltitle.value)){ alert('أدخل عنوان المحاضرة'); return false; }
    if(!ok(ldate.value)) { alert('أدخل تاريخ المحاضرة'); return false; }
    return true;
  }

  // تخزين
  const STORE_KEY = 'qr_att_rows_v4';
  const SEEN_STRICT_KEY = 'qr_seen_strict_v4';
  const SEEN_BY_DEVICE_KEY = 'qr_seen_device_v4';

  const rows = JSON.parse(localStorage.getItem(STORE_KEY) || '[]');
  const seenStrict = new Set(JSON.parse(localStorage.getItem(SEEN_STRICT_KEY) || '[]'));
  const seenByDevice = new Set(JSON.parse(localStorage.getItem(SEEN_BY_DEVICE_KEY) || '[]'));

  // استرجاع الحقول
  sess.value   = localStorage.getItem('qr_sess')  || randCode();
  ltitle.value = localStorage.getItem('qr_title') || '';
  ldate.value  = localStorage.getItem('qr_date')  || todayISO();
  noDup.checked= (localStorage.getItem('qr_noDup') ?? '1') === '1';

  // رسم الجدول
  function rowKey(rec){ // s::id::name::section (strict)
    const ss=(rec.session||'').trim(), id=(rec.id||'').trim();
    const nm=(rec.full_name||'').trim(), sc=(rec.section||'').trim();
    return `${ss}::${id}::${nm}::${sc}`;
  }
  function deviceKey(rec){ return `${(rec.session||'').trim()}::${(rec.id||'').trim()}`; }

  function drawRows(){
    const nf = (fName.value||'').trim().toLowerCase();
    const sf = (fSec.value||'').trim().toLowerCase();
    tbody.innerHTML='';
    rows.forEach((rec,i)=>{
      if(nf && !String(rec.full_name).toLowerCase().includes(nf)) return;
      if(sf && !String(rec.section).toLowerCase().includes(sf)) return;

      const tr=document.createElement('tr');

      // No.
      let td0=document.createElement('td'); td0.textContent=i+1; tr.appendChild(td0);

      // Name editable
      let td1=document.createElement('td'); td1.contentEditable="true"; td1.textContent=rec.full_name;
      td1.addEventListener('blur', ()=>{
        const v = td1.textContent.trim();
        if(!v){ alert('الاسم لا يمكن أن يكون فارغًا'); td1.textContent=rec.full_name; return; }
        // إزالة مفتاح strict القديم ثم إعادة إضافته بالجديد
        const oldKey = rowKey(rec);
        seenStrict.delete(oldKey);
        rec.full_name = v;
        const newKey = rowKey(rec);
        seenStrict.add(newKey);
        persistSeen();
        persistRows();
      });
      tr.appendChild(td1);

      // Section
      const td2=document.createElement('td'); td2.textContent=rec.section||''; tr.appendChild(td2);
      // Date (تاريخ حضور)
      const td3=document.createElement('td'); td3.textContent=rec.timestamp||''; tr.appendChild(td3);
      // Lecture Title
      const td4=document.createElement('td'); td4.textContent=rec.lecture_title||''; tr.appendChild(td4);
      // Lecture Date
      const td5=document.createElement('td'); td5.textContent=rec.lecture_date||''; tr.appendChild(td5);
      // Session
      const td6=document.createElement('td'); td6.textContent=rec.session||''; tr.appendChild(td6);
      // ID
      const td7=document.createElement('td'); td7.textContent=rec.id||''; tr.appendChild(td7);

      // Actions: حذف
      const td8=document.createElement('td');
      const del=document.createElement('button');
      del.textContent='حذف';
      del.className='danger';
      del.onclick=()=>{
        if(!confirm('حذف هذا السطر؟')) return;
        // إزالة من rows
        const idx = rows.indexOf(rec);
        if(idx>-1) rows.splice(idx,1);
        // إزالة من seen sets للسماح بإعادة المسح عند الحاجة
        seenStrict.delete(rowKey(rec));
        seenByDevice.delete(deviceKey(rec));
        persistSeen();
        persistRows();
        drawRows();
        countEl.textContent = rows.length;
      };
      td8.appendChild(del); tr.appendChild(td8);

      tbody.appendChild(tr);
    });
    countEl.textContent = rows.length;
  }
  function persistRows(){ localStorage.setItem(STORE_KEY, JSON.stringify(rows)); }
  function persistSeen(){
    localStorage.setItem(SEEN_STRICT_KEY, JSON.stringify(Array.from(seenStrict)));
    localStorage.setItem(SEEN_BY_DEVICE_KEY, JSON.stringify(Array.from(seenByDevice)));
  }
  drawRows();

  // حفظ الحقول
  [sess,ltitle,ldate,noDup].forEach(el=>{
    el.addEventListener('change', ()=>{
      if(el===noDup) localStorage.setItem('qr_noDup', noDup.checked ? '1':'0');
      else{
        if(!ok(sess.value)) sess.value=randCode();
        localStorage.setItem('qr_sess',  sess.value.trim());
        localStorage.setItem('qr_title', ltitle.value.trim());
        localStorage.setItem('qr_date',  ldate.value);
      }
    });
  });

  // فلاتر
  [fName,fSec].forEach(el=>el.addEventListener('input', drawRows));
  clearFilters.onclick = ()=>{ fName.value=''; fSec.value=''; drawRows(); };

  // أصوات (WebAudio): نجاح/خطأ
  function beep(freq=880, ms=130, vol=0.02){
    try{
      const ac = new (window.AudioContext||window.webkitAudioContext)();
      const o = ac.createOscillator(); const g = ac.createGain();
      o.type='sine'; o.frequency.value=freq; g.gain.value=vol;
      o.connect(g).connect(ac.destination);
      o.start(); g.gain.exponentialRampToValueAtTime(0.00001, ac.currentTime + ms/1000);
      o.stop(ac.currentTime + ms/1000 + 0.01);
    }catch(e){}
  }
  const successBeep = ()=>beep(920,140,0.03);
  const errorBeep   = ()=>{beep(220,120,0.03); setTimeout(()=>beep(180,120,0.03),120);};

  // توست
  function showToast(name, ok=true){
    toast.textContent = (ok?'✅ تمت إضافة: ':'❌ ') + (name||'');
    toast.style.background = ok ? '#ecfdf5' : '#fee2e2';
    toast.style.color = ok ? '#065f46' : '#991b1b';
    toast.style.borderColor = ok ? '#a7f3d0' : '#fecaca';
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 1500);
  }

  // سياسة التكرارات
  function strictKey(obj){
    const ss=(obj.session||'').trim(), id=(obj.id||'').trim();
    const nm=(obj.full_name||'').trim(), sc=(obj.section||'').trim();
    return `${ss}::${id}::${nm}::${sc}`;
  }
  function deviceOnlyKey(obj){
    return `${(obj.session||'').trim()}::${(obj.id||'').trim()}`;
  }

  function addRowFromQR(obj){
    const rec = {
      id: obj.id || '',
      session: obj.session || sess.value.trim(),
      full_name: (obj.full_name||'').trim(),
      section: (obj.section||'').trim(),
      timestamp: todayISO(),                 // تاريخ فقط
      lecture_title: ltitle.value.trim(),
      lecture_date: ldate.value
    };

    const sKey = strictKey(rec);
    if(seenStrict.has(sKey)){ // نفس الـQR بالضبط
      status.textContent = 'تم مسح نفس الكود مسبقًا لهذه الجلسة.';
      errorBeep(); showToast('تمت قراءته مسبقًا', false);
      return;
    }
    const dKey = deviceOnlyKey(rec);
    if(noDup.checked && seenByDevice.has(dKey)){ // جهاز مسجّل مسبقًا
      status.textContent = 'هذا الجهاز سجّل حضورًا لهذه الجلسة مسبقًا.';
      errorBeep(); showToast('جهاز مكرر', false);
      return;
    }

    // سجّل المفاتيح
    seenStrict.add(sKey);
    if(noDup.checked) seenByDevice.add(dKey);
    persistSeen();

    rows.push(rec); persistRows();

    // رسم صف جديد مع فلاش
    const tr=document.createElement('tr'); tr.className='flash';
    const cells = [
      rows.length, rec.full_name, rec.section, rec.timestamp,
      rec.lecture_title, rec.lecture_date, rec.session, rec.id
    ];
    cells.forEach((v,idx)=>{
      const td=document.createElement('td');
      if(idx===1){ // الاسم قابل للتعديل
        td.contentEditable="true"; td.textContent=rec.full_name;
        td.addEventListener('blur', ()=>{
          const val = td.textContent.trim();
          if(!val){ alert('الاسم لا يمكن أن يكون فارغًا'); td.textContent=rec.full_name; return; }
          // عدّل المفتاح الصارم
          seenStrict.delete(rowKey(rec));
          rec.full_name = val;
          seenStrict.add(rowKey(rec));
          persistSeen(); persistRows();
        });
      } else td.textContent=v;
      tr.appendChild(td);
    });
    // Actions
    const tdAct=document.createElement('td');
    const del=document.createElement('button'); del.textContent='حذف'; del.className='danger';
    del.onclick=()=>{
      if(!confirm('حذف هذا السطر؟')) return;
      const idx = rows.indexOf(rec);
      if(idx>-1) rows.splice(idx,1);
      // أزل من seen للسماح بإعادة المسح
      seenStrict.delete(rowKey(rec));
      seenByDevice.delete(deviceKey(rec));
      persistSeen(); persistRows(); drawRows();
      countEl.textContent = rows.length;
    };
    tdAct.appendChild(del); tr.appendChild(tdAct);

    tbody.appendChild(tr);
    countEl.textContent = rows.length;

    successBeep(); showToast(rec.full_name || 'طالب', true);
    status.textContent = 'تمت الإضافة: ' + (rec.full_name||'');
  }

  // QR الطلاب (يمرّر العنوان والتاريخ)
  function buildStudentURL(){
    const u = new URL('student.html', location.href);
    u.searchParams.set('s', sess.value.trim());
    u.searchParams.set('t', ltitle.value.trim());
    u.searchParams.set('d', ldate.value);
    return u.toString();
  }
  function showStudentQR(){
    if(!requireFields()) return;
    const link = buildStudentURL();
    const api  = 'https://api.qrserver.com/v1/create-qr-code/?size=320x320&data=' + encodeURIComponent(link);
    stuQR.src = api; stuQRWrap.style.display = 'flex'; stuLink.textContent = link;
    qrBig.src = api.replace('320x320','640x640');
  }
  showStuQR.onclick = showStudentQR;
  stuQR.onclick = ()=>{ qrModal.style.display='flex'; };
  qrModal.onclick = ()=>{ qrModal.style.display='none'; };

  // كاميرا المسح
  async function listCams(){
    const devices = await navigator.mediaDevices.enumerateDevices();
    const vids = devices.filter(d => d.kind === 'videoinput');
    camSel.innerHTML = '';
    vids.forEach((d,i)=>{
      const opt = document.createElement('option');
      opt.value = d.deviceId;
      opt.textContent = d.label || `كاميرا ${i+1}`;
      camSel.appendChild(opt);
    });
  }
  let stream=null, anim=null;
  async function start(){
    if(!requireFields()) return;
    try{
      await listCams();
      const constraints = {
        video: camSel.value ? { deviceId: { exact: camSel.value } } : { facingMode:'environment' },
        audio:false
      };
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream; await video.play();
      status.textContent = 'الماسح يعمل… وجّه الكاميرا نحو QR';
      scanLoop();
    }catch(e){
      status.textContent = 'تعذّر تشغيل الكاميرا: '+e.message;
      errorBeep();
    }
  }
  function stop(){
    if(anim) cancelAnimationFrame(anim);
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    status.textContent = 'متوقف.';
  }
  async function scanLoop(){
    if(!video.videoWidth){ anim=requestAnimationFrame(scanLoop); return; }
    canvas.width=video.videoWidth; canvas.height=video.videoHeight;
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
    const code = jsQR(imgData.data, imgData.width, imgData.height);
    if(code && code.data){
      try{
        const obj = JSON.parse(code.data);
        if(!obj || !obj.session || !obj.full_name){
          status.textContent = 'QR ناقص معلومات'; errorBeep(); showToast('QR ناقص', false);
        } else if((obj.session||'').trim() !== sess.value.trim()){
          status.textContent = 'QR لجلسة مختلفة!'; errorBeep(); showToast('جلسة مختلفة', false);
        } else {
          addRowFromQR(obj);
        }
      }catch(e){
        status.textContent = 'QR غير صالح'; errorBeep(); showToast('QR غير صالح', false);
      }
      await new Promise(r=>setTimeout(r, 800));
    }
    anim=requestAnimationFrame(scanLoop);
  }
  startBtn.onclick = start; stopBtn.onclick = stop;

  // CSV (تاريخ فقط)
  csvBtn.onclick = ()=>{
    const header = ['No.','Full Name','Section','Date','Lecture Title','Lecture Date','Session','ID'];
    const data = rows.map((r,i)=>[i+1,r.full_name,r.section,r.timestamp,r.lecture_title,r.lecture_date,r.session,r.id]);
    const csv = [header.join(',')].concat(data.map(r=>r.map(x=>String(x).replace(/"/g,'""')).map(x=>`"${x}"`).join(','))).join('\n');
    const blob = new Blob(["\uFEFF"+csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download = 'attendance_'+(sess.value||'session')+'.csv'; a.click();
  };

  // إنهاء الجلسة: تصفير كلشي وتوليد كود جديد
  endBtn.onclick = ()=>{
    if(!confirm('تأكيد إنهاء الجلسة؟ سيتم تفريغ الحضور والمدخلات.')) return;
    localStorage.removeItem(STORE_KEY);
    localStorage.removeItem(SEEN_STRICT_KEY);
    localStorage.removeItem(SEEN_BY_DEVICE_KEY);
    rows.splice(0,rows.length);
    seenStrict.clear(); seenByDevice.clear();
    tbody.innerHTML=''; countEl.textContent='0';

    noDup.checked = true; localStorage.setItem('qr_noDup','1');

    ltitle.value=''; ldate.value=todayISO();
    sess.value = randCode();
    localStorage.setItem('qr_sess',sess.value);
    localStorage.setItem('qr_title','');
    localStorage.setItem('qr_date',ldate.value);

    showStuQR.click();
    status.textContent = 'تم إنهاء الجلسة وتصفير البيانات.';
    showToast('تم إنهاء الجلسة', true);
  };

  // بدء مبدئي
  if(!ldate.value) ldate.value = todayISO();
  showStuQR.click();
})();
</script>
  <footer style="text-align: center; padding: 10px; background-color: #f2f2f2; color: #333; font-family: Arial, sans-serif; font-size: 14px; position: fixed; bottom: 0; width: 100%;">
  تم إنشاء هذا البرنامج بواسطة الطالب <strong>محمد مصطفى</strong> من فرع الجيوتكنيك
</footer>
</body>
</html>


