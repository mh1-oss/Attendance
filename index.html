<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>نظام حضور بالـ QR (HTML) — جاهز</title>
<style>
:root{--bg:#0b1020;--card:#141a2f;--text:#eef2ff;--muted:#9aa4c7;--accent:#5da8ff}
*{box-sizing:border-box}body{margin:0;font-family:tahoma,arial,sans-serif;background:var(--bg);color:var(--text)}
.container{max-width:980px;margin:0 auto;padding:20px}
.card{background:var(--card);border-radius:16px;padding:18px;box-shadow:0 6px 24px #0006;margin:12px 0}
h1,h2,h3{margin:0 0 10px}
label{display:block;margin:10px 0 6px}
input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #2a3358;background:#0f1530;color:#fff}
button,.btn{display:inline-block;padding:10px 16px;border-radius:12px;border:none;background:var(--accent);color:#00112b;font-weight:700;cursor:pointer;text-decoration:none}
.btn.secondary{background:#243055;color:#c9d8ff}
.row{display:flex;gap:12px;flex-wrap:wrap}.col{flex:1 1 260px}
.muted{color:var(--muted)}
.qr{display:flex;gap:22px;align-items:center;flex-wrap:wrap}
img.qr{background:#fff;padding:8px;border-radius:12px}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #2a3358;text-align:right}
th{color:#b9c8ff}
.small{font-size:12px}
.pill{display:inline-block;background:#0f1530;border:1px solid #2a3358;padding:6px 10px;border-radius:999px}
.tabs{display:flex;gap:6px;margin:10px 0}
.tabs button{background:#19203d;color:#bcd0ff}
.tabs button.active{background:var(--accent);color:#00112b}
</style>
</head>
<body>
<div class="container">
  <h1>نظام تسجيل الحضور بالـ QR – HTML (نسخة جاهزة)</h1>
  <div class="tabs">
    <button id="tab-teacher" class="active">وضع الأستاذ</button>
    <button id="tab-student">وضع الطالب</button>
  </div>

  <div id="teacher" class="card">
    <h2>لوحة الأستاذ</h2>
    <div class="row">
      <div class="col">
        <label>رابط السيرفر (Apps Script Web App)</label>
        <input id="endpoint" placeholder="الصق رابط Web App هنا" />
        <div class="small muted">تم تعبئته تلقائيًا. يمكنك تغييره لاحقًا إذا نشرت نسخة جديدة.</div>
      </div>
      <div class="col">
        <label>رمز الجلسة</label>
        <input id="session-code" placeholder="مثال: A5K9Q" />
      </div>
    </div>
    <div style="margin:10px 0; display:flex; gap:8px; flex-wrap:wrap">
      <button id="new-session">جلسة جديدة + QR</button>
      <button id="get-list" class="btn secondary">جلب الحضور</button>
      <button id="export-csv" class="btn secondary">تصدير CSV</button>
    </div>
    <div id="qr-wrap" class="qr" style="display:none">
      <img id="qr" class="qr" width="220" height="220" alt="QR" />
      <div>
        <h3>اعرض هذا الكود على الشاشة</h3>
        <div id="student-link-box" class="pill"></div>
        <div class="small muted">يمسح الطالب الـQR ويفتح نفس الصفحة في وضع الطالب.</div>
      </div>
    </div>

    <div id="table-wrap" class="card" style="display:none">
      <h3>قائمة الحضور</h3>
      <table id="tbl">
        <thead><tr><th>#</th><th>الاسم الكامل</th><th>الرقم الجامعي</th><th>الشعبة</th><th>الوقت</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="student" class="card" style="display:none">
    <h2>نموذج الطالب</h2>
    <p class="muted">الرجاء إدخال معلوماتك للتسجيل في الجلسة <span id="sess-pill" class="pill"></span></p>
    <label>الاسم الكامل</label>
    <input id="full-name" placeholder="مثال: مصطفى محمد فوزي" />
    <label>الرقم الجامعي (اختياري)</label>
    <input id="student-id" placeholder="مثال: 2023xxxx" />
    <label>الشعبة / المجموعة</label>
    <input id="section" placeholder="مثال: A / 3" />
    <div style="margin-top:10px">
      <button id="submit">تسجيل الحضور</button>
    </div>
    <p id="ok" class="muted" style="display:none;margin-top:10px">✅ تم تسجيل حضورك. شكراً لك.</p>
  </div>

  <p class="small muted">هذا الملف يشتغل مباشرة محليًا أو أونلاين. الحفظ يتم في Google Sheet عبر Apps Script.</p>
</div>

<script>
const PRESET_ENDPOINT = "https://script.google.com/macros/s/AKfycbyAtQogOhvCG_pfNX0tzvplj0a4tXdil2uhj_2RfsH4m3NtktPTYbph0oiUpNbLohOj/exec";
if (!localStorage.getItem('qr_att_endpoint')) { localStorage.setItem('qr_att_endpoint', PRESET_ENDPOINT); }
const DEFAULT_ENDPOINT = localStorage.getItem('qr_att_endpoint') || PRESET_ENDPOINT;

const urlParams = new URLSearchParams(location.search);
let currentSession = urlParams.get('s') || localStorage.getItem('qr_att_session') || '';

const tabTeacherBtn = document.getElementById('tab-teacher');
const tabStudentBtn = document.getElementById('tab-student');
const teacherBox = document.getElementById('teacher');
const studentBox = document.getElementById('student');
const endpointInput = document.getElementById('endpoint');
const sessionInput = document.getElementById('session-code');
const newSessionBtn = document.getElementById('new-session');
const getListBtn = document.getElementById('get-list');
const exportBtn = document.getElementById('export-csv');
const qrWrap = document.getElementById('qr-wrap');
const qrImg = document.getElementById('qr');
const studentLinkBox = document.getElementById('student-link-box');
const tableWrap = document.getElementById('table-wrap');
const tblBody = document.querySelector('#tbl tbody');

const sessPill = document.getElementById('sess-pill');
const fullName = document.getElementById('full-name');
const studentId = document.getElementById('student-id');
const section = document.getElementById('section');
const submitBtn = document.getElementById('submit');
const okMsg = document.getElementById('ok');

function showTeacher(){teacherBox.style.display='block';studentBox.style.display='none';tabTeacherBtn.classList.add('active');tabStudentBtn.classList.remove('active')}
function showStudent(){teacherBox.style.display='none';studentBox.style.display='block';tabStudentBtn.classList.add('active');tabTeacherBtn.classList.remove('active')}

tabTeacherBtn.onclick = showTeacher;
tabStudentBtn.onclick = showStudent;

if (urlParams.get('s')) {
  currentSession = urlParams.get('s');
  localStorage.setItem('qr_att_session', currentSession);
  showStudent();
} else {
  showTeacher();
}

endpointInput.value = DEFAULT_ENDPOINT;
sessionInput.value = currentSession;
updateSessPill();

function updateSessPill(){
  if(currentSession){ sessPill.textContent = 'الكود: '+currentSession; sessPill.style.display='inline-block' } else { sessPill.style.display='none' }
}

function randCode(len=5){
  const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let s=''; for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)];
  return s;
}
function buildStudentURL(code){
  const base = location.origin + location.pathname;
  const u = base + '?s=' + encodeURIComponent(code);
  return u;
}
function setQR(url){
  const api = 'https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=' + encodeURIComponent(url);
  qrImg.src = api; qrWrap.style.display='flex';
  studentLinkBox.textContent = url;
}
function saveEndpoint(){
  const ep = endpointInput.value.trim();
  if(ep){localStorage.setItem('qr_att_endpoint', ep)}
}
function saveSession(){
  const s = sessionInput.value.trim();
  currentSession = s; localStorage.setItem('qr_att_session', s); updateSessPill();
}

newSessionBtn.onclick = () => {
  const ep = endpointInput.value.trim(); if(!ep){alert('رجاءً الصق رابط Web App أولاً'); return}
  saveEndpoint();
  const code = randCode();
  sessionInput.value = code; saveSession();
  setQR(buildStudentURL(code));
};

getListBtn.onclick = async () => {
  saveEndpoint(); saveSession();
  if(!endpointInput.value.trim() || !currentSession){alert('أدخل رابط Web App ورمز الجلسة'); return}
  const url = endpointInput.value.trim() + '?mode=list&s=' + encodeURIComponent(currentSession);
  const res = await fetch(url);
  if(!res.ok){ alert('تعذر الجلب. تحقق من صلاحيات النشر'); return }
  const json = await res.json();
  renderTable(json.rows||[]);
};

function renderTable(rows){
  tblBody.innerHTML='';
  rows.forEach((r,i)=>{
    const tr = document.createElement('tr');
    const cells = [i+1, r.full_name||'', r.student_id||'', r.section||'', r.timestamp||''];
    cells.forEach(c=>{ const td=document.createElement('td'); td.textContent=c; tr.appendChild(td); });
    tblBody.appendChild(tr);
  });
  tableWrap.style.display = rows.length? 'block':'none';
}

exportBtn.onclick = () => {
  const rows = [...tblBody.querySelectorAll('tr')].map(tr => [...tr.children].map(td=>td.textContent));
  const csv = ['#,Full Name,Student ID,Section,Timestamp'].concat(rows.map(r=>r.join(','))).join('\n');
  const blob = new Blob(["\ufeff"+csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='attendance_'+(currentSession||'session')+'.csv'; a.click();
};

submitBtn.onclick = async () => {
  saveEndpoint();
  const ep = endpointInput.value.trim();
  const s = currentSession || sessionInput.value.trim();
  if(!ep || !s){ alert('لا يوجد رابط Web App أو رمز الجلسة'); return }
  const payload = {
    mode: 'add',
    session: s,
    full_name: fullName.value.trim(),
    student_id: studentId.value.trim(),
    section: section.value.trim(),
    ua: navigator.userAgent
  };
  if(!payload.full_name){ alert('أدخل الاسم الكامل'); return }
  try{
    const res = await fetch(ep, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    if(!res.ok){ throw new Error('HTTP '+res.status) }
    okMsg.style.display='block';
    fullName.value=''; studentId.value=''; section.value='';
  }catch(e){ alert('تعذر الإرسال. تحقق من الإعدادات والإنترنت.'); }
};

endpointInput.addEventListener('change', saveEndpoint);
sessionInput.addEventListener('change', saveSession);
</script>
</body>
</html>
