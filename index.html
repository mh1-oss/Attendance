<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>لوحة الأستاذ — ماسح حضور بالـ QR (بدون داتابيس)</title>
<style>
  :root{--bg:#0b1020;--card:#141a2f;--text:#eef2ff;--muted:#9aa4c7;--accent:#5da8ff}
  *{box-sizing:border-box}
  body{margin:0;font-family:tahoma,arial,sans-serif;background:var(--bg);color:var(--text)}
  .wrap{max-width:980px;margin:0 auto;padding:18px}
  .card{background:#141a2f;border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 6px 20px #0006}
  h1,h2{margin:0 0 10px}
  label{display:block;margin:10px 0 6px}
  input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #2a3358;background:#0f1530;color:#fff}
  button{padding:10px 16px;border-radius:12px;border:none;background:#5da8ff;color:#00112b;font-weight:700;cursor:pointer}
  .row{display:flex;gap:12px;flex-wrap:wrap}.col{flex:1 1 240px}
  .muted{color:#9aa4c7;font-size:12px}
  .pill{display:inline-block;background:#0f1530;border:1px solid #2a3358;padding:6px 10px;border-radius:999px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  video{width:100%;max-height:320px;border-radius:12px;background:#000}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #2a3358;text-align:right}
  th{color:#b9c8ff}
  .ok{color:#8ef58e}.bad{color:#ff8e8e}
</style>
</head>
<body>
<div class="wrap">
  <h1>لوحة الأستاذ — ماسح حضور بالـ QR</h1>

  <div class="card">
    <h2>إعداد الجلسة</h2>
    <div class="row">
      <div class="col">
        <label>رمز الجلسة</label>
        <input id="sess" placeholder="مثال: A5K9Q" />
      </div>
      <div class="col">
        <label>اسم المحاضرة</label>
        <input id="ltitle" placeholder="مثال: محاضرة 5 — إنتاج البذور" />
      </div>
      <div class="col">
        <label>تاريخ المحاضرة</label>
        <input id="ldate" type="date" />
      </div>
    </div>
    <div class="controls">
      <button id="startScan">تشغيل الماسح</button>
      <button id="stopScan">إيقاف</button>
      <button id="clearList">تفريغ القائمة</button>
      <a id="studentLink" class="pill" href="student.html" target="_blank" rel="noopener">فتح صفحة الطالب</a>
    </div>
    <div class="muted">انشر كود الجلسة للطلاب (شفهيًا أو على السبورة). كل طالب يولّد QR من صفحته.</div>
  </div>

  <div class="card">
    <h2>كاميرا المسح</h2>
    <div class="row">
      <div class="col">
        <label>اختيار الكاميرا</label>
        <select id="cameraSelect"></select>
      </div>
      <div class="col">
        <label>حالة الماسح</label>
        <div id="status" class="muted">جاهز…</div>
      </div>
    </div>
    <video id="video" playsinline></video>
    <canvas id="canvas" style="display:none"></canvas>
  </div>

  <div class="card">
    <h2>قائمة الحضور <span id="count" class="pill">0</span></h2>
    <div class="controls">
      <button id="csvBtn">تصدير CSV</button>
    </div>
    <table>
      <thead>
        <tr><th>#</th><th>الاسم</th><th>الشعبة</th><th>الوقت</th><th>المحاضرة</th><th>تاريخها</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- jsQR لفكّ شيفرة QR محلياً -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
(function(){
  const sess   = document.getElementById('sess');
  const ltitle = document.getElementById('ltitle');
  const ldate  = document.getElementById('ldate');
  const status = document.getElementById('status');
  const video  = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx    = canvas.getContext('2d');
  const camSel = document.getElementById('cameraSelect');
  const startBtn = document.getElementById('startScan');
  const stopBtn  = document.getElementById('stopScan');
  const clearBtn = document.getElementById('clearList');
  const csvBtn   = document.getElementById('csvBtn');
  const tbody    = document.getElementById('tbody');
  const countEl  = document.getElementById('count');

  // حفظ محلي
  sess.value   = localStorage.getItem('qr_sess')  || '';
  ltitle.value = localStorage.getItem('qr_title') || '';
  ldate.value  = localStorage.getItem('qr_date')  || new Date().toISOString().slice(0,10);
  [sess,ltitle,ldate].forEach(el => el.addEventListener('change', save));
  function save(){
    localStorage.setItem('qr_sess',  sess.value.trim());
    localStorage.setItem('qr_title', ltitle.value.trim());
    localStorage.setItem('qr_date',  ldate.value);
  }

  // قائمة الحضور بالذاكرة
  const rows = [];
  const seen = new Set(); // لتجنّب التكرار (بناءً على id فريد داخل الـQR)
  function addRow(r){
    if(seen.has(r.id)) return; // مكرر
    seen.add(r.id);
    rows.push(r);
    const tr = document.createElement('tr');
    [rows.length, r.full_name, r.section, r.timestamp, r.lecture_title, r.lecture_date]
      .forEach(v => { const td=document.createElement('td'); td.textContent=v; tr.appendChild(td); });
    tbody.appendChild(tr);
    countEl.textContent = rows.length;
  }

  // الكاميرات
  async function listCams(){
    const devices = await navigator.mediaDevices.enumerateDevices();
    const vids = devices.filter(d => d.kind === 'videoinput');
    camSel.innerHTML = '';
    vids.forEach((d,i)=>{
      const opt = document.createElement('option');
      opt.value = d.deviceId;
      opt.textContent = d.label || `كاميرا ${i+1}`;
      camSel.appendChild(opt);
    });
  }

  let stream = null, anim = null;
  async function start(){
    try{
      if(!sess.value.trim()){ alert('اكتب رمز الجلسة أولاً'); return }
      save();
      await listCams();
      const constraints = {
        video: camSel.value ? { deviceId: { exact: camSel.value } }
                            : { facingMode: 'environment' },
        audio: false
      };
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      await video.play();
      status.innerHTML = '<span class="ok">الماسح يعمل… وجّه الكاميرا نحو QR</span>';
      scanLoop();
    }catch(e){
      status.innerHTML = '<span class="bad">تعذّر تشغيل الكاميرا: '+e.message+'</span>';
    }
  }
  function stop(){
    if(anim) cancelAnimationFrame(anim);
    if(stream){
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }
    status.textContent = 'متوقف.';
  }
  async function scanLoop(){
    if(!video.videoWidth){ anim = requestAnimationFrame(scanLoop); return; }
    canvas.width  = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
    const code = jsQR(imgData.data, imgData.width, imgData.height);
    if(code && code.data){
      try{
        const obj = JSON.parse(code.data);
        // التحقق من الجلسة
        if((obj.session||'').trim() !== sess.value.trim()){
          status.innerHTML = '<span class="bad">QR لجلسة مختلفة!</span>';
        }else{
          addRow({
            id: obj.id, // فريد من الطالب
            full_name: obj.full_name || '',
            section:   obj.section   || '',
            timestamp: new Date().toLocaleString(),
            lecture_title: ltitle.value.trim(),
            lecture_date:  ldate.value
          });
          status.innerHTML = '<span class="ok">تمت الإضافة: '+(obj.full_name||'')+'</span>';
        }
      }catch(e){
        status.innerHTML = '<span class="bad">QR غير صالح</span>';
      }
      // مهلة صغيرة لتفادي قراءة متكررة لنفس الكود
      await new Promise(r=>setTimeout(r, 900));
    }
    anim = requestAnimationFrame(scanLoop);
  }

  startBtn.onclick = start;
  stopBtn.onclick  = stop;
  clearBtn.onclick = ()=>{
    rows.length = 0; seen.clear(); tbody.innerHTML=''; countEl.textContent='0'; status.textContent='تم التفريغ.';
  };

  // تصدير CSV
  csvBtn.onclick = ()=>{
    const header = ['#','Full Name','Section','Timestamp','Lecture Title','Lecture Date'];
    const data   = rows.map((r,i)=>[i+1,r.full_name,r.section,r.timestamp,r.lecture_title,r.lecture_date]);
    const csv = [header.join(',')].concat(data.map(r=>r.join(','))).join('\n');
    const blob = new Blob(["\uFEFF"+csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'attendance_'+(sess.value||'session')+'.csv';
    a.click();
  };

  // تهيئة رابط صفحة الطالب (يفتحها بسرعة)
  const stu = new URL('student.html', location.href);
  document.getElementById('studentLink').href = stu.toString();
})();
</script>
</body>
</html>
