<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>لوحة الأستاذ — ماسح حضور بالـ QR (بدون داتابيس)</title>
<style>
  :root{--bg:#0b1020;--card:#141a2f;--text:#eef2ff;--muted:#9aa4c7;--accent:#5da8ff;--ok:#30e08a;--bad:#ff7a86}
  *{box-sizing:border-box}
  body{margin:0;font-family:tahoma,arial,sans-serif;background:var(--bg);color:var(--text)}
  .wrap{max-width:980px;margin:0 auto;padding:18px}
  .card{background:#141a2f;border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 6px 20px #0006}
  h1,h2{margin:0 0 10px}
  label{display:block;margin:10px 0 6px}
  input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #2a3358;background:#0f1530;color:#fff}
  button{padding:10px 16px;border-radius:12px;border:none;background:#5da8ff;color:#00112b;font-weight:700;cursor:pointer}
  .row{display:flex;gap:12px;flex-wrap:wrap}.col{flex:1 1 240px}
  .muted{color:#9aa4c7;font-size:12px}
  .pill{display:inline-block;background:#0f1530;border:1px solid #2a3358;padding:6px 10px;border-radius:999px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  video{width:100%;max-height:320px;border-radius:12px;background:#000}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #2a3358;text-align:right}
  th{color:#b9c8ff}
  .ok{color:var(--ok)}.bad{color:var(--bad)}
  /* QR الطالب الكبير */
  .qrbox{display:none;align-items:center;gap:16px;flex-wrap:wrap}
  img.qr{background:#fff;border-radius:12px;padding:8px;cursor:pointer}
  /* توست */
  #toast{position:fixed;top:16px;left:50%;transform:translateX(-50%);background:#1b2a3f;border:1px solid #2a3358;padding:12px 16px;border-radius:12px;box-shadow:0 6px 20px #0008;display:none;font-size:16px}
  #toast.ok{border-color:#1f7b57}
  /* Modal */
  .modal{position:fixed;inset:0;background:#000a;display:none;align-items:center;justify-content:center;padding:16px}
  .modal img{max-width:95vw;max-height:90vh;background:#fff;border-radius:16px;padding:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>لوحة الأستاذ — ماسح حضور بالـ QR</h1>

  <div class="card">
    <h2>إعداد الجلسة</h2>
    <div class="row">
      <div class="col">
        <label>رمز الجلسة (يتولد تلقائياً)</label>
        <input id="sess" placeholder="مثال: A5K9Q">
      </div>
      <div class="col">
        <label>اسم المحاضرة</label>
        <input id="ltitle" placeholder="مثال: محاضرة 5 — إنتاج البذور">
      </div>
      <div class="col">
        <label>تاريخ المحاضرة</label>
        <input id="ldate" type="date">
      </div>
    </div>
    <div class="controls">
      <button id="showStuQR">إظهار QR لصفحة الطالب</button>
      <button id="startScan">تشغيل الماسح</button>
      <button id="stopScan">إيقاف</button>
      <button id="clearList">تفريغ القائمة</button>
    </div>
    <div class="muted">اطلب من الطلاب فتح صفحتهم عبر مسح الـQR التالي أو إدخال كود الجلسة.</div>

    <!-- QR يفتح صفحة الطالب مباشرة -->
    <div id="stuQRWrap" class="qrbox" style="margin-top:10px">
      <div>
        <div class="muted">اضغط على صورة الـQR لتكبيرها على كامل الشاشة.</div>
        <img id="stuQR" class="qr" width="220" height="220" alt="Student QR (open student.html)">
        <div class="pill" id="stuLink"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>كاميرا المسح</h2>
    <div class="row">
      <div class="col">
        <label>اختيار الكاميرا</label>
        <select id="cameraSelect"></select>
      </div>
      <div class="col">
        <label>حالة الماسح</label>
        <div id="status" class="muted">جاهز…</div>
      </div>
    </div>
    <video id="video" playsinline></video>
    <canvas id="canvas" style="display:none"></canvas>
  </div>

  <div class="card">
    <h2>قائمة الحضور <span id="count" class="pill">0</span></h2>
    <div class="controls">
      <button id="csvBtn">تصدير CSV</button>
    </div>
    <table>
      <thead>
        <tr><th>#</th><th>الاسم</th><th>الشعبة</th><th>الوقت</th><th>المحاضرة</th><th>تاريخها</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- توست -->
<div id="toast" class="ok">✅ تمت إضافة: <span id="toastName"></span></div>
<!-- Modal لتكبير QR -->
<div id="qrModal" class="modal"><img id="qrBig" alt="QR كبير"></div>

<!-- jsQR لفكّ شيفرة QR محلياً -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<!-- صوت نجاح (WAV صغير Base64) -->
<audio id="beep">
  <source src="data:audio/wav;base64,UklGRlQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAAAQU5BMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwAAAA" type="audio/wav">
</audio>

<script>
(function(){
  const sess   = document.getElementById('sess');
  const ltitle = document.getElementById('ltitle');
  const ldate  = document.getElementById('ldate');
  const status = document.getElementById('status');
  const video  = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx    = canvas.getContext('2d');
  const camSel = document.getElementById('cameraSelect');
  const startBtn = document.getElementById('startScan');
  const stopBtn  = document.getElementById('stopScan');
  const clearBtn = document.getElementById('clearList');
  const csvBtn   = document.getElementById('csvBtn');
  const tbody    = document.getElementById('tbody');
  const countEl  = document.getElementById('count');
  const beep     = document.getElementById('beep');
  const toast    = document.getElementById('toast');
  const toastName= document.getElementById('toastName');

  // QR الطالب الكبير
  const showStuQR = document.getElementById('showStuQR');
  const stuQRWrap = document.getElementById('stuQRWrap');
  const stuQR     = document.getElementById('stuQR');
  const stuLink   = document.getElementById('stuLink');
  const qrModal   = document.getElementById('qrModal');
  const qrBig     = document.getElementById('qrBig');

  // حفظ محلي + كود تلقائي
  function randCode(n=5){const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';let s='';for(let i=0;i<n;i++) s+=c[Math.floor(Math.random()*c.length)];return s;}
  sess.value   = localStorage.getItem('qr_sess')  || randCode();
  ltitle.value = localStorage.getItem('qr_title') || '';
  ldate.value  = localStorage.getItem('qr_date')  || new Date().toISOString().slice(0,10);
  [sess,ltitle,ldate].forEach(el => el.addEventListener('change', save));
  function save(){
    if(!sess.value.trim()) sess.value = randCode();
    localStorage.setItem('qr_sess',  sess.value.trim());
    localStorage.setItem('qr_title', ltitle.value.trim());
    localStorage.setItem('qr_date',  ldate.value);
  }

  // إنشاء رابط و QR لصفحة الطالب
  function buildStudentURL(){
    const u = new URL('student.html', location.href);
    u.searchParams.set('s', sess.value.trim());
    // ملاحظة: الطالب لا يحتاج عنوان/تاريخ هنا، فقط الكود؛ ممكن نمررهم للعرض إن أردت
    return u.toString();
  }
  function showStudentQR(){
    if(!sess.value.trim()){ sess.value = randCode(); save(); }
    const link = buildStudentURL();
    const api  = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(link);
    stuQR.src = api;
    stuQRWrap.style.display = 'flex';
    stuLink.textContent = link;
    qrBig.src = api.replace('300x300','600x600');
  }
  showStuQR.onclick = showStudentQR;
  stuQR.onclick = ()=>{ qrModal.style.display='flex'; };
  qrModal.onclick = ()=>{ qrModal.style.display='none'; };

  // قائمة الحضور بالذاكرة
  const rows = [];
  const seen = new Set(); // يمنع التكرار
  function makeKey(obj){
    const sid = (obj.id||'').trim();
    const ss  = (obj.session||'').trim();
    if(sid && ss) return ss+'::'+sid;
    // احتياط إذا طالب بدون id
    return ss+'::'+(obj.full_name||'').trim()+'::'+(obj.section||'').trim();
  }
  function addRow(r){
    const key = makeKey(r);
    if(seen.has(key)) return;
    seen.add(key);
    const rec = {
      id: r.id || '',
      session: r.session || sess.value.trim(),
      full_name: r.full_name || '',
      section: r.section || '',
      timestamp: new Date().toLocaleString(),
      lecture_title: ltitle.value.trim(),
      lecture_date: ldate.value
    };
    rows.push(rec);
    const tr = document.createElement('tr');
    [rows.length, rec.full_name, rec.section, rec.timestamp, rec.lecture_title, rec.lecture_date]
      .forEach(v => { const td=document.createElement('td'); td.textContent=v; tr.appendChild(td); });
    tbody.appendChild(tr);
    countEl.textContent = rows.length;
    // توست + صوت
    toastName.textContent = rec.full_name || 'طالب';
    toast.style.display = 'block';
    setTimeout(()=>toast.style.display='none', 1800);
    beep.currentTime = 0; beep.play().catch(()=>{ /* silent */ });
  }

  // الكاميرات
  async function listCams(){
    const devices = await navigator.mediaDevices.enumerateDevices();
    const vids = devices.filter(d => d.kind === 'videoinput');
    camSel.innerHTML = '';
    vids.forEach((d,i)=>{
      const opt = document.createElement('option');
      opt.value = d.deviceId;
      opt.textContent = d.label || `كاميرا ${i+1}`;
      camSel.appendChild(opt);
    });
  }

  let stream = null, anim = null;
  async function start(){
    try{
      if(!sess.value.trim()){ sess.value = randCode(); save(); }
      await listCams();
      const constraints = {
        video: camSel.value ? { deviceId: { exact: camSel.value } }
                            : { facingMode: 'environment' },
        audio: false
      };
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      await video.play();
      status.innerHTML = '<span class="ok">الماسح يعمل… وجّه الكاميرا نحو QR</span>';
      scanLoop();
    }catch(e){
      status.innerHTML = '<span class="bad">تعذّر تشغيل الكاميرا: '+e.message+'</span>';
    }
  }
  function stop(){
    if(anim) cancelAnimationFrame(anim);
    if(stream){
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }
    status.textContent = 'متوقف.';
  }
  async function scanLoop(){
    if(!video.videoWidth){ anim = requestAnimationFrame(scanLoop); return; }
    canvas.width  = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
    const code = jsQR(imgData.data, imgData.width, imgData.height);
    if(code && code.data){
      try{
        const obj = JSON.parse(code.data);
        if((obj.session||'').trim() !== sess.value.trim()){
          status.innerHTML = '<span class="bad">QR لجلسة مختلفة!</span>';
        }else{
          addRow(obj);
          status.innerHTML = '<span class="ok">تمت الإضافة: '+(obj.full_name||'')+'</span>';
        }
      }catch(e){
        status.innerHTML = '<span class="bad">QR غير صالح</span>';
      }
      // منع التكرار السريع لنفس الكود
      await new Promise(r=>setTimeout(r, 900));
    }
    anim = requestAnimationFrame(scanLoop);
  }

  startBtn.onclick = start;
  stopBtn.onclick  = stop;
  clearBtn.onclick = ()=>{
    rows.length = 0; seen.clear(); tbody.innerHTML=''; countEl.textContent='0'; status.textContent='تم التفريغ.';
  };

  // تصدير CSV
  csvBtn.onclick = ()=>{
    const header = ['#','Full Name','Section','Timestamp','Lecture Title','Lecture Date'];
    const data   = rows.map((r,i)=>[i+1,r.full_name,r.section,r.timestamp,r.lecture_title,r.lecture_date]);
    const csv = [header.join(',')].concat(data.map(r=>r.join(','))).join('\n');
    const blob = new Blob(["\uFEFF"+csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'attendance_'+(sess.value||'session')+'.csv';
    a.click();
  };

  // تهيئة QR الطالب فوراً لسهولة الاستخدام
  showStudentQR();
})();
</script>
</body>
</html>
