<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>لوحة الأستاذ — حضور بالـ QR (بدون داتابيس)</title>
<style>
  :root{
    --bg:#f7f9fc; --card:#ffffff; --text:#0f172a; --muted:#64748b; --accent:#2563eb;
    --border:#e5e7eb; --ok:#16a34a; --bad:#dc2626; --chip:#eef2ff;
  }
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text)}
  .wrap{max-width:1000px;margin:0 auto;padding:20px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 2px 10px rgba(15,23,42,.06)}
  h1{margin:0 0 10px;font-size:22px} h2{margin:0 0 10px;font-size:18px}
  label{display:block;margin:8px 0 6px;font-size:14px;color:var(--muted)}
  input,select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--text)}
  .row{display:flex;gap:12px;flex-wrap:wrap}.col{flex:1 1 240px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:var(--chip);color:#111827;cursor:pointer}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  button.danger{background:#fef2f2;border-color:#fecaca;color:#b91c1c}
  .muted{color:var(--muted);font-size:13px}
  .pill{display:inline-block;background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px}
  video{width:100%;max-height:360px;border-radius:12px;background:#000}
  table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:right}
  th{background:#fafafa;color:#111827}
  #stuQRWrap{display:none;align-items:center;gap:16px;flex-wrap:wrap}
  img.qr{background:#fff;border:1px solid var(--border);border-radius:12px;padding:8px;cursor:pointer}
  #toast{position:fixed;top:16px;left:50%;transform:translateX(-50%);background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0;
         padding:12px 16px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.1);display:none;font-weight:600}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px}
  .modal img{max-width:95vw;max-height:90vh;background:#fff;border-radius:16px;padding:12px;border:1px solid var(--border)}
  .switch{display:inline-flex;align-items:center;gap:8px}
  .switch input{width:auto}
</style>
</head>
<body>
<div class="wrap">
  <h1>لوحة الأستاذ — حضور بالـ QR (بدون داتابيس)</h1>

  <div class="card">
    <h2>إعداد الجلسة</h2>
    <div class="row">
      <div class="col">
        <label>كود الجلسة (يتولد تلقائيًا)</label>
        <input id="sess" placeholder="مثال: A5K9Q">
      </div>
      <div class="col">
        <label>اسم المحاضرة</label>
        <input id="ltitle" placeholder="مثال: محاضرة 5 — إنتاج البذور">
      </div>
      <div class="col">
        <label>تاريخ المحاضرة</label>
        <input id="ldate" type="date">
      </div>
      <div class="col">
        <label>سياسة التكرارات</label>
        <div class="switch">
          <input type="checkbox" id="noDup">
          <span class="muted">منع التكرارات (مُستحسن)</span>
        </div>
      </div>
    </div>
    <div class="controls">
      <button id="showStuQR" class="primary">إظهار QR لصفحة الطالب</button>
      <button id="startScan">تشغيل الماسح</button>
      <button id="stopScan">إيقاف</button>
      <button id="csvBtn">تصدير CSV</button>
      <button id="endBtn" class="danger">إنهاء الجلسة</button>
    </div>
    <div class="muted">اطلب من الطلاب فتح صفحتهم عبر مسح الـ QR التالي أو إدخال كود الجلسة.</div>

    <div id="stuQRWrap" style="margin-top:10px">
      <div>
        <div class="muted">إضغط على صورة الـ QR لتكبيرها.</div>
        <img id="stuQR" class="qr" width="240" height="240" alt="QR لفتح صفحة الطالب">
        <div class="pill" id="stuLink"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>كاميرا المسح</h2>
    <div class="row">
      <div class="col">
        <label>اختيار الكاميرا</label>
        <select id="cameraSelect"></select>
      </div>
      <div class="col">
        <label>حالة الماسح</label>
        <div id="status" class="muted">جاهز…</div>
      </div>
    </div>
    <video id="video" playsinline></video>
    <canvas id="canvas" style="display:none"></canvas>
  </div>

  <div class="card">
    <h2>قائمة الحضور <span id="count" class="pill">0</span></h2>
    <table>
      <thead>
        <tr>
          <th>No.</th><th>Full Name</th><th>Section</th><th>Timestamp</th><th>Lecture Title</th><th>Lecture Date</th><th>Session</th><th>ID</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<div id="toast">✅ تمت إضافة: <span id="toastName"></span></div>
<div id="qrModal" class="modal"><img id="qrBig" alt="QR كبير"></div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
(function(){
  // عناصر
  const sess   = document.getElementById('sess');
  const ltitle = document.getElementById('ltitle');
  const ldate  = document.getElementById('ldate');
  const noDup  = document.getElementById('noDup');
  const showStuQR = document.getElementById('showStuQR');
  const stuQRWrap = document.getElementById('stuQRWrap');
  const stuQR  = document.getElementById('stuQR');
  const stuLink= document.getElementById('stuLink');
  const qrModal= document.getElementById('qrModal');
  const qrBig  = document.getElementById('qrBig');
  const status = document.getElementById('status');
  const video  = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx    = canvas.getContext('2d');
  const camSel = document.getElementById('cameraSelect');
  const startBtn = document.getElementById('startScan');
  const stopBtn  = document.getElementById('stopScan');
  const csvBtn   = document.getElementById('csvBtn');
  const endBtn   = document.getElementById('endBtn');
  const tbody    = document.getElementById('tbody');
  const countEl  = document.getElementById('count');
  const toast    = document.getElementById('toast');
  const toastName= document.getElementById('toastName');

  // تخزين محلي: استرجاع
  function randCode(n=5){const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';let s='';for(let i=0;i<n;i++) s+=c[Math.floor(Math.random()*c.length)];return s;}
  const STORE_KEY = 'qr_att_rows_v2';
  const rows = JSON.parse(localStorage.getItem(STORE_KEY) || '[]');
  const seen = new Set(JSON.parse(localStorage.getItem('qr_seen_v2') || '[]'));
  sess.value   = localStorage.getItem('qr_sess')  || randCode();
  ltitle.value = localStorage.getItem('qr_title') || '';
  ldate.value  = localStorage.getItem('qr_date')  || new Date().toISOString().slice(0,10);
  noDup.checked= (localStorage.getItem('qr_noDup') ?? '1') === '1';

  // إعادة رسم الجدول من التخزين
  function redraw(){
    tbody.innerHTML='';
    rows.forEach((rec,i)=>{
      const tr=document.createElement('tr');
      [i+1, rec.full_name, rec.section, rec.timestamp, rec.lecture_title, rec.lecture_date, rec.session, rec.id]
        .forEach(v => { const td=document.createElement('td'); td.textContent=v; tr.appendChild(td); });
      tbody.appendChild(tr);
    });
    countEl.textContent = rows.length;
  }
  redraw();

  // حفظ فوري للحقل
  [sess,ltitle,ldate,noDup].forEach(el=>{
    el.addEventListener('change', ()=>{
      if(el===noDup) localStorage.setItem('qr_noDup', noDup.checked ? '1':'0');
      else{
        if(!sess.value.trim()) sess.value = randCode();
        localStorage.setItem('qr_sess',  sess.value.trim());
        localStorage.setItem('qr_title', ltitle.value.trim());
        localStorage.setItem('qr_date',  ldate.value);
      }
    });
  });

  // صوت نجاح — نحاول Audio، وإن فشل نستعمل WebAudio
  async function playBeep(){
    try{
      // موجة ساين قصيرة عبر WebAudio (مضمونة)
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type='sine'; o.frequency.value=880; g.gain.value=0.001; // مستوى منخفض ومريح
      o.connect(g).connect(ctx.destination);
      o.start(); g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.12);
      o.stop(ctx.currentTime+0.13);
    }catch(e){/* تجاهل */}
  }

  // مفتاح تكرارات بحسب سياسة الأستاذ
  function makeKey(obj){
    const sid = (obj.id||'').trim();
    const ss  = (obj.session||'').trim();
    if(sid && ss) return ss+'::'+sid;
    return ss+'::'+(obj.full_name||'').trim()+'::'+(obj.section||'').trim();
  }

  function addRowFromQR(obj){
    const rec = {
      id: obj.id || '',
      session: obj.session || sess.value.trim(),
      full_name: obj.full_name || '',
      section: obj.section || '',
      timestamp: new Date().toLocaleString(),
      lecture_title: ltitle.value.trim(),
      lecture_date: ldate.value
    };
    const key = makeKey(rec);
    if(noDup.checked && seen.has(key)) return; // منع تكرار
    if(!noDup.checked){
      // عند السماح بالتكرار لا نضيف للمجموعة حتى لا تمنع لاحقًا
    }else{
      seen.add(key);
      localStorage.setItem('qr_seen_v2', JSON.stringify(Array.from(seen)));
    }
    rows.push(rec);
    localStorage.setItem(STORE_KEY, JSON.stringify(rows));
    const tr=document.createElement('tr');
    [rows.length, rec.full_name, rec.section, rec.timestamp, rec.lecture_title, rec.lecture_date, rec.session, rec.id]
      .forEach(v => { const td=document.createElement('td'); td.textContent=v; tr.appendChild(td); });
    tbody.appendChild(tr);
    countEl.textContent = rows.length;

    toastName.textContent = rec.full_name || 'طالب';
    toast.style.display = 'block';
    setTimeout(()=>toast.style.display='none', 1500);
    playBeep();
  }

  // QR للطلاب
  function buildStudentURL(){
    const u = new URL('student.html', location.href);
    u.searchParams.set('s', sess.value.trim());
    return u.toString();
  }
  function showStudentQR(){
    if(!sess.value.trim()) sess.value = randCode();
    localStorage.setItem('qr_sess', sess.value.trim());
    const link = buildStudentURL();
    const api  = 'https://api.qrserver.com/v1/create-qr-code/?size=320x320&data=' + encodeURIComponent(link);
    stuQR.src = api;
    stuQRWrap.style.display = 'flex';
    stuLink.textContent = link;
    document.getElementById('qrBig').src = api.replace('320x320','640x640');
  }
  showStuQR.onclick = showStudentQR;
  stuQR.onclick = ()=>{ qrModal.style.display='flex'; };
  qrModal.onclick = ()=>{ qrModal.style.display='none'; };

  // كاميرا المسح
  async function listCams(){
    const devices = await navigator.mediaDevices.enumerateDevices();
    const vids = devices.filter(d => d.kind === 'videoinput');
    camSel.innerHTML = '';
    vids.forEach((d,i)=>{
      const opt = document.createElement('option');
      opt.value = d.deviceId;
      opt.textContent = d.label || `كاميرا ${i+1}`;
      camSel.appendChild(opt);
    });
  }
  let stream=null, anim=null;
  async function start(){
    try{
      await listCams();
      const constraints = {
        video: camSel.value ? { deviceId: { exact: camSel.value } } : { facingMode:'environment' },
        audio:false
      };
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream; await video.play();
      status.textContent = 'الماسح يعمل… وجّه الكاميرا نحو QR';
      scanLoop();
    }catch(e){
      status.textContent = 'تعذّر تشغيل الكاميرا: '+e.message;
    }
  }
  function stop(){
    if(anim) cancelAnimationFrame(anim);
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    status.textContent = 'متوقف.';
  }
  async function scanLoop(){
    if(!video.videoWidth){ anim=requestAnimationFrame(scanLoop); return; }
    canvas.width=video.videoWidth; canvas.height=video.videoHeight;
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
    const code = jsQR(imgData.data, imgData.width, imgData.height);
    if(code && code.data){
      try{
        const obj = JSON.parse(code.data);
        if((obj.session||'').trim() !== sess.value.trim()){
          status.textContent = 'QR لجلسة مختلفة!'; 
        }else{
          addRowFromQR(obj);
          status.textContent = 'تمت الإضافة: ' + (obj.full_name||'');
        }
      }catch(e){ status.textContent = 'QR غير صالح'; }
      await new Promise(r=>setTimeout(r, 800));
    }
    anim=requestAnimationFrame(scanLoop);
  }
  startBtn.onclick = start; stopBtn.onclick = stop;

  // CSV نظيف
  csvBtn.onclick = ()=>{
    const header = ['No.','Full Name','Section','Timestamp','Lecture Title','Lecture Date','Session','ID'];
    const data = rows.map((r,i)=>[i+1,r.full_name,r.section,r.timestamp,r.lecture_title,r.lecture_date,r.session,r.id]);
    const csv = [header.join(',')].concat(data.map(r=>r.map(x=>String(x).replace(/"/g,'""')).map(x=>`"${x}"`).join(','))).join('\n');
    const blob = new Blob(["\uFEFF"+csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download = 'attendance_'+(sess.value||'session')+'.csv'; a.click();
  };

  // إنهاء الجلسة: تصفير كلشي
  endBtn.onclick = ()=>{
    if(!confirm('تأكيد إنهاء الجلسة؟ سيتم تفريغ الحضور والمدخلات.')) return;
    localStorage.removeItem(STORE_KEY);
    localStorage.removeItem('qr_seen_v2');
    localStorage.removeItem('qr_title');
    localStorage.removeItem('qr_date');
    localStorage.removeItem('qr_sess');
    localStorage.setItem('qr_noDup','1');
    rows.splice(0,rows.length); seen.clear();
    tbody.innerHTML=''; countEl.textContent='0';
    ltitle.value=''; ldate.value=new Date().toISOString().slice(0,10);
    noDup.checked=true;
    sess.value = randCode();
    showStuQR.click(); // يولّد QR جديد بسرعة
    status.textContent = 'تم إنهاء الجلسة وتصفير البيانات.';
  };

  // تهيئة سريعة
  showStudentQR(); // يولّد QR منذ البداية لسهولة الدخول
})();
</script>
</body>
</html>
